---
#
# Configure Server Profiles and Policies
#
# The hosts group used is provided by the group variable or defaulted to 'Intersight_Standalone'.
# You can specify a specific host (or host group) on the command line:
#   ansible-playbook ... -e group=<your host group>
#   e.g., ansible-playbook server_profiles.yml -e group=TME_Demo
#
- hosts: "{{ group | default('Intersight_Standalone') }}"
  connection: local
  gather_facts: false
  vars:
    # Create an anchor for api_info that can be used throughout the file
    api_info: &api_info
      api_private_key: "{{ api_private_key }}"
      api_key_id: "{{ api_key_id }}"
      api_uri: "{{ api_uri | default(omit) }}"
      validate_certs: "{{ validate_certs | default(omit) }}"
      state: "{{ state | default(omit) }}"
    # Server Profile name default
    profile_name: "SP-{{ inventory_hostname }}"
  tasks:
    #
    # Configure profiles specific to server (run for each server in the inventory)
    # Server Profiles role will register a profile_resp and profile_resp list (from all hosts) can be used by policy tasks
    #
    - name: "Configure {{ profile_name }} Server Profile"
      intersight_rest_api:
        <<: *api_info
        resource_path: /server/Profiles
        query_params:
          $filter: "Name eq '{{ profile_name }}'"
        api_body: {
          "Name": "{{ profile_name }}",
          "AssignedServer": {
            "Moid": "{{ server_moid }}"
          }
        }
      register: profile_resp
      when: server_moid is defined
      delegate_to: localhost
      tags: server_profiles
    # Deploy (or perform other profile_action) when tag is set, e.g., --tags deploy
    # profile_action can be given on the command line if needed, e.g., ansible-playbook ... -e profile_action=Unassign
    - name: Deploy (or user defined profile_action) Server Profile
      intersight_rest_api:
        <<: *api_info
        resource_path: /server/Profiles
        query_params:
          $filter: "Name eq '{{ profile_name }}'"
        api_body: {
          "Action": "{{ profile_action | default('Deploy') }}"
        }
      delegate_to: localhost
      tags: [never, deploy]
    #
    # Enclose policy tasks in a block that runs once
    # Policy API body is specified in a role specific vars section for each role import
    # See https://intersight.com/apidocs/ or https://intersight.com/mobrowser/ for information on setting resource_path and api_body
    #
    - block:
        # Boot Order policy config
        - import_role:
            name: policies/server_policies
          vars:
            resource_path: /boot/PrecisionPolicies
            api_body: {
              "Name": "vmedia-local-disk",
              "ConfiguredBootMode": "Legacy",
              "BootDevices": [
                {
                  "ObjectType": "boot.VirtualMedia",
                  "Enabled": true,
                  "Name": "remote-vmedia",
                  "Subtype": "cimc-mapped-dvd"
                },
                {
                  "ObjectType": "boot.LocalDisk",
                  "Enabled": true,
                  "Name": "localdisk",
                  "Slot": "",
                  "Bootloader": null
                }
              ],
            }
          tags: boot_order
        # Virtual Media policy config
        - import_role:
            name: policies/server_policies
          vars:
            resource_path: /vmedia/Policies
            api_body: {
              "Name": "nfs-cdd",
              "Mappings": [
                {
                  "MountProtocol": "nfs",
                  "VolumeName": "nfs-cdd",
                  "DeviceType": "cdd",
                  "HostName": "172.28.224.77",
                  "RemotePath": "/mnt/SHARE/ISOS/ESX",
                  "RemoteFile": "VMware_ESXi_6.7.0_10302608_Custom_Cisco_6.7.1.1.iso"
                }
              ]
            }
          tags: virtual_media
        # Bios policy config
        - import_role:
            name: policies/server_policies
          vars:
            resource_path: /bios/Policies
            api_body: {
              "Name": "adaptive-memory",
              "CiscoAdaptiveMemTraining": "enabled"
            }
          tags: bios
        # Snmp policy config
        - import_role:
            name: policies/server_policies
          vars:
            resource_path: /snmp/Policies
            api_body: {
              "Name": "snmp-local",
              "AccessCommunityString": "galaxy",
              "CommunityAccess": "Disabled",
              "Enabled": true,
              "EngineId": "",
              "SnmpPort": 161,
              "SnmpTraps": [],
              "SnmpUsers": [
                {
                  "ObjectType": "snmp.User",
                  "AuthType": "SHA",
                  "IsAuthPasswordSet": true,
                  "IsPrivacyPasswordSet": true,
                  "Name": "TMEUCS",
                  "PrivacyType": "AES",
                  "SecurityLevel": "AuthPriv",
                  "AuthPassword": "password",
                  "PrivacyPassword": "password"
                }
              ],
              "SysContact": "Cisco TME",
              "SysLocation": "Cisco TME DC",
              "TrapCommunity": "galaxy"
            }
          tags: snmp
        # Ldap policy config
        - block:
            # for policies that reference other policies, config the basic policies 1st and then reference in the main policy
            # Ldap Providers
            - name: "Configure LDAP Providers"
              intersight_rest_api:
                <<: *api_info
                resource_path: /iam/LdapProviders
                query_params:
                  $filter: "Server eq 'tmedemo.cisco.com'"
                api_body: {
                  "Port": 389,
                  "Server": "tmedemo.cisco.com"
                }
              register: ldap_provider
            # Role used by Ldap Group
            - name: "Get EndPoint Role for LDAP Groups"
              intersight_rest_api:
                <<: *api_info
                resource_path: /iam/EndPointRoles
                query_params:
                  $filter: "Name eq 'admin'"
              register: endpoint_role
            # Ldap Groups
            - name: "Configure LDAP Groups"
              intersight_rest_api:
                <<: *api_info
                resource_path: /iam/LdapGroups
                query_params:
                  $filter: "Name eq 'demo1'"
                api_body: {
                  "Domain": "cisco.com",
                  "Name": "demo1",
                  "Role": "{{ endpoint_role.api_response.Moid }}"
                }
              register: ldap_group
            # Ldap Policies with references to Providers/Groups configured above
            - import_role:
                name: policies/server_policies
              vars:
                resource_path: /iam/LdapPolicies
                api_body: {
                  "Name": "ldap-local",
                  "BaseProperties": {
                    "ObjectType": "iam.LdapBaseProperties",
                    "Attribute": "CiscoAvPair",
                    "BaseDn": "DC=CISCO,DC=COM",
                    "BindDn": "",
                    "BindMethod": "LoginCredentials",
                    "Domain": "cisco.com",
                    "EnableEncryption": true,
                    "EnableGroupAuthorization": false,
                    "Filter": "sAMAccountName",
                    "GroupAttribute": "memberOf",
                    "IsPasswordSet": false,
                    "NestedGroupSearchDepth": 128,
                    "Timeout": 20
                  },
                  "DnsParameters": {
                    "ObjectType": "iam.LdapDnsParameters",
                    "SearchDomain": "",
                    "SearchForest": "",
                    "Source": "Extracted"
                  },
                  "EnableDns": false,
                  "Enabled": true,
                  "UserSearchPrecedence": "LocalUserDb",
                  "Groups": [
                    {
                      "ObjectType": "iam.LdapGroup",
                      "Moid": "{{ ldap_group.api_response.Moid }}",
                    }
                  ],
                  "Providers": [
                    {
                      "ObjectType": "iam.LdapProvider",
                      "Moid": "{{ ldap_provider.api_response.Moid }}",
                    }
                  ]
                }
          tags: ldap
      # Policies are common, so only run this block once and not for every host
      run_once: true
      delegate_to: localhost
