---
# retrieve facts from Intersight servers
- hosts: localhost
  connection: local
  gather_facts: false
  vars:
    api_info: &api_info
      api_private_key: "{{ var_api_private_key | default('~/Downloads/SecretKey.txt') }}"
      api_key_id: "{{ var_api_key_id | default('5a3404ac3768393836093cab/5c92d2fb7564612d3048be4c/5c92d31e7564612d3048c2c2') }}"
      # define the following as needed in your environment
      # api_uri:
      # validate_certs:
      # state:
    inventory_file: "{{ var_inventory_file | default('standalone_server_inventory') }}"
  tasks:
    # find all servers
    - intersight_facts:
        <<: *api_info
        server_names:
      register: all_results
    # put standalone servers (IMC) into a file
    - lineinfile:
        path: "{{ playbook_dir }}/{{ inventory_file }}"
        line: "{{ item.Name }} server_moid={{ item.Moid }} model={{ item.Model }} boot_policy={{ (item.Tags | items2dict(key_name='Key', value_name='Value'))['boot_policy'] | default('na') }}"
        create: true
      # ansible and jmespath contains have type differences, so to/from_json used
      loop: "{{ all_results.intersight_servers | json_query(platform_query) | to_json | from_json | json_query(model_query) }}"
      loop_control:
        label: "{{ item.Name }}"
      vars:
        # filter for IMC and C-Series only (no HX)
        platform_query: "[?PlatformType=='IMC']"
        model_query: "[?contains(Model, 'UCSC-C')]"
      when: all_results.intersight_servers is defined
